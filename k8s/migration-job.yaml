# =============================================================================
# Kubernetes Job - Database Migration
# =============================================================================
# Runs Prisma migrations using a custom Docker image that contains
# the Prisma schema and all migration files
# =============================================================================

apiVersion: batch/v1
kind: Job
metadata:
  name: database-migration
  namespace: ftc-app-${ENVIRONMENT}
  labels:
    app: database-migration
    component: infrastructure
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 900  # 15 minutes
  template:
    metadata:
      labels:
        app: database-migration
    spec:
      restartPolicy: OnFailure
      serviceAccountName: migration-service-account
      imagePullSecrets:
        - name: ghcr-secret

      containers:
      - name: migrate
        # Migration image built from Dockerfile.migrations
        # Contains Prisma schema + migrations baked in
        image: ghcr.io/fiap-tech-challenge-projects/database-managed-infra/migrations:${ENVIRONMENT}
        imagePullPolicy: Always
        command:
          - sh
          - -c
          - |
            set -e

            echo "üîê Fetching database credentials from Secrets Manager..."
            SECRET_JSON=$(aws secretsmanager get-secret-value \
              --secret-id fiap-tech-challenge/${ENVIRONMENT}/database/credentials \
              --region ${AWS_REGION} \
              --query SecretString \
              --output text)

            # Export DATABASE_URL for Prisma
            export DATABASE_URL=$(echo "$SECRET_JSON" | jq -r '.DATABASE_URL')

            DB_HOST=$(echo "$SECRET_JSON" | jq -r '.host')
            DB_PORT=$(echo "$SECRET_JSON" | jq -r '.port')
            DB_NAME=$(echo "$SECRET_JSON" | jq -r '.dbname')

            echo "üìä Database connection: ${DB_HOST}:${DB_PORT}/${DB_NAME}"

            echo "üìù Listing available migrations..."
            ls -la /app/prisma/migrations/ 2>/dev/null || echo "‚ö†Ô∏è  No migrations directory found"

            echo "üöÄ Running Prisma migrations..."
            cd /app
            prisma migrate deploy --schema=./prisma/schema.prisma

            echo "‚úÖ Migration completed successfully!"

        env:
        - name: AWS_REGION
          value: "us-east-1"
        - name: ENVIRONMENT
          value: "${ENVIRONMENT}"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: migration-service-account
  namespace: ftc-app-${ENVIRONMENT}
  # Production: Pod inherits permissions from EKS node IAM role
  # Node role (aws_iam_role.eks_nodes) has permissions for:
  # - Secrets Manager (read secrets)
  # - RDS (connect to database)
  # - ECR (pull container images)
  #
  # AWS ACADEMY: Add LabRole annotation for Academy environment
  # annotations:
  #   eks.amazonaws.com/role-arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/LabRole
